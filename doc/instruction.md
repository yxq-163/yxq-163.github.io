# Gitlab-ci User Instruction

---

# 0 使用说明
本项目提供gitlab-ci 流水线搭建、运行说明及示例


## 0.1 主要文件目录
├── deploy\prod/                        # K8S脚本  
│   └── devops-svc.yaml                 # service部署脚本  
│   └── devops-yaml                     # deploy部署脚本  
├── docs/                               # 文档  
│   └── config.toml                     # gitlab runner 配置示例文件  
│   └── gitlab-runner-create.sh         # gitlab runner 容器启动命令  
│   └── instruction.md                  # 使用说明  
│   └── kubectl-config.sh               # kubectl部署及配置  
│   └── gitlab-create.sh                # gitlab启动命令  
├── public/                             # 入口 HTML  
├── src/                                # vue源码  
├── Dockerfile                          # dockers镜像打包脚本  
├── default.conf                        # nginx配置文件  
├── README.md                           # README.md  
└── vue.config.js                       # vue 配置文件  

## 0.2 使用方式简介
拉取项目代码，按照说明文档进行系统配置，相关脚本均在doc目录下

---

# 1 总体流程
图一为jenkins流水线  
![Jenkins Pipeline](http://10.20.91.100:9980/root/vue-ci-sample/-/raw/master/doc/pic/jenkins.png)

图二gitlab-ci流水线  
![gitlab-ci Pipeline](http://10.20.91.100:9980/root/vue-ci-sample/-/raw/master/doc/pic/gitlab.png)

gitlab runner基本等同于jenkins的作用，通过流水线执行脚本进行项目编译、打包、发布等工作，需要与harbor，k8s进行交互。  
有两类gitlab runner：共享runner和指派runner，共享runner可以被所有项目使用，指派runner一般指派个特定的一个或几个项目。每个工程项目可以关联任意数量的共享runner和指派runner，在项目ci流程触发后，系统会选择一个runner执行本次的ci流程，其中共享runner的tags必须与job中设定的tags匹配才可匹配选择。  
runner为流水线运行的基础环境，runner会根据.gitlab-ci.yml，调度excuter来执行文件中定义的各个job，完成流水线各个步骤。  

---

# 2 gitlab部署
## 2.1 标准规范
镜像实例命名：gitlab{版本号}  
容器本地映射目录：  
/data/gitlab/{版本号}/config    #映射配置文件  
/data/gitlab/{版本号}/logs      #映射日志文件  
/data/gitlab/{版本号}/data      #映射数据文件  
端口映射：  
9980-http端口  
9922-ssh端口  

## 2.2 部署脚本
```
docker run \
 -itd  \
 -p 9980:9980 \
 -p 9922:22 \
 -v /data/gitlab/15.8.0/config:/etc/gitlab  \
 -v /data/gitlab/15.8.0/logs:/var/log/gitlab \
 -v /data/gitlab/15.8.0/data:/var/opt/gitlab \
 --restart always \
 --privileged=true \
 --name gitlab15.8.0 \
 gitlab/gitlab-ce:15.8.0-ce.0
```

示例脚本：[gitlab-create.sh](http://10.20.91.100:9980/root/vue-ci-sample/-/blob/master/doc/gitlab-create.sh)

---

# 3 gitlab runner 部署
## 3.1 标准规范

## 3.2 安装及配置kubectl
此步骤目的在于使runner服务器可以操作生产环境的k8s集群，在服务器配置一次即可，若项目不基于k8s部署，可跳过。

```
mkdir -p /usr/local/bin/
mkdir -p /root/.kube/
scp -r root@10.20.91.101:/usr/local/bin/kubectl/ /usr/local/bin/
scp root@10.20.91.101:/root/.kube/config /root/.kube/
echo "10.20.91.101  lb.kubesphere.local" >> /etc/hosts
```

其中"10.20.91.101  lb.kubesphere.local" 从k8s服务器hosts文件中获取。  
若在runner服务器执行命令kubectl get nodes可以查询到集群信息，代表部署成功。  

示例脚本：[kubectl-config.sh](http://10.20.91.100:9980/root/vue-ci-sample/-/blob/master/doc/kubectl-config.sh)    

## 3.3 创建gitlab runner容器

镜像为gitlab官方gitlab-runner镜像  
容器命名为 gitlab-runner-{工程名}-{序号}  
容器目录命名： /data/gitlab/gitlab-runner/{工程名}-{序号}，如：  

```
docker run -d --name gitlab-runner-sample-01 --restart always \
  -v /data/gitlab/gitlab-runner/sample-01:/etc/gitlab-runner \
  -v /var/run/docker.sock:/var/run/docker.sock \
  gitlab/gitlab-runner:latest
```

示例脚本：[gitlab-runner-create.sh](http://10.20.91.100:9980/root/vue-ci-sample/-/blob/master/doc/gitlab-runner-create.sh)  

## 3.4 gitlab runner配置

进入上步创建的容器示例，注册gitlab  
```
docker exec -it gitlab-runner-sample-01 /bin/bash  
```
输入命令gitlab-runner register，根据提示依次设置  
容器描述格式为：gitlab-runner-{工程名}-{序号}  
tags建议如下："runner名称";"执行器类型 docker/shell/ssh等";"打包工具 maven/npmD等";"环境 /dev/test/prod等";  

![runner-register](http://10.20.91.100:9980/root/vue-ci-sample/-/raw/master/doc/pic/register.png)

共享runner的token获取方式：  
![shared-runner](http://10.20.91.100:9980/root/vue-ci-sample/-/raw/master/doc/pic/shared.png)

指派runner的token获取方式：
![arranged-runner](http://10.20.91.100:9980/root/vue-ci-sample/-/raw/master/doc/pic/point.png)

注册完成后，会在runner持久化目录下生成config.toml文件，可以通过对文件的修改，更新runner的配置。  
将config.toml文件中privileged 设置为true （docker in docker 模式需要管理员权限）  
在config.toml文件中volumes中，添加"/usr/local/bin/kubectl:/usr/local/bin/kubectl","/root/.kube/:/root/.kube/"  （使容器内部可以操作k8s集群，如果不使用k8s，可以不设置）  

```
###this file is auto-generated by gitlab when this runner is registed

concurrent = 1
check_interval = 0

[session_server]
  session_timeout = 1800

[[runners]]
  name = "vue-sample"
  url = "http://10.20.91.100:9980/"
  token = "xxxxxxxxxxxxxxxxx"
  executor = "docker"
  [runners.custom_build_dir]
  [runners.cache]
    [runners.cache.s3]
    [runners.cache.gcs]
    [runners.cache.azure]
  [runners.docker]
    tls_verify = false
    image = "docker:20.10.12"
    privileged = true
    disable_entrypoint_overwrite = false
    oom_kill_disable = false
    disable_cache = false
    volumes = ["/cache","/usr/local/bin/kubectl:/usr/local/bin/kubectl","/root/.kube/:/root/.kube/"]
    shm_size = 0

###this file is auto-generated by gitlab when this runner is registed
```

注册完成后，可以在gitlab中，查看到runner信息。  


示例gitlab runner 配置文件： [config.toml](http://10.20.91.100:9980/root/vue-ci-sample/-/blob/master/doc/config.toml)  

---

# 4 gitlab executor 配置
## 4.1 .gitlab-ci.yml说明
.gitlab-ci.yml文件一般放在根目录下，用于定义流水线各个执行器及job。

yml文件分为两部分，全局配置与job配置。
示例中全局配置关键词variables，主要用于定义全局变量，其它全局关键词还包括default，include，stages，workflow
示例中配置了一个job，即docker-build-and-deploy-k8s。


```
variables:

  #docker服务启动参数
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_DRIVER: overlay2 
  DOCKER_TLS_CERTDIR: ""
  #下面流水线需要用到的变量

  DOCKERHUB_NAMESPACE: 'library'
  BRANCH_NAME: master

  APP_NAME: 'vue-ci-sample'
  BUILD_NUMBER: $CI_PIPELINE_ID

docker-build-and-deploy-k8s:
  stage: deploy
  image: docker:20.10.12
  services:
    - name: docker:20.10.12-dind
      command: ["--insecure-registry=10.20.91.100"]

  script:
    - echo "This job building  something, $REGISTRY_USER, $REGISTRY_PASSWORD , $REGISTRY"
    - echo "$REGISTRY_PASSWORD" | docker login $REGISTRY -u "$REGISTRY_USER" --password-stdin
    - docker build -f Dockerfile -t $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:SNAPSHOT-$BRANCH_NAME-$BUILD_NUMBER .
    - docker push  $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:SNAPSHOT-$BRANCH_NAME-$BUILD_NUMBER
    - apk add --no-cache gettext #在apline操作系统中，安装 envsubst 命令

    - envsubst < deploy/prod/devops-svc.yaml | kubectl apply -f -  #再创建 service deployment pod
    - envsubst < deploy/prod/devops.yaml | kubectl apply -f -
    - sleep 6000

  rules:
    - allow_failure: true

```

示例文件：.gitlab-ci.yml
更多说明可以参考官方文档：http://10.20.91.100:9980/root/vue-sample-1/-/settings/ci_cd

## 4.2 环境变量
### 4.2.1 标准规范
变量命名规范：环境变量名使用英文大写，多个单词间使用下划线连接。
存放账号、密码及其它敏感信息的环境变量，应避免通过明文保存在.yml配置文件中，需要通过gitlab CICD 设置外部环境变量。

图xx

一般环境变量通过variables，保存在yml文件中。
以下给出约定的环境变量名：

HARBOR_URL                  #harbor地址  
HARBOR_PASSWORD             #harbor登录密码  
HARBOR_USER                 #harbor登录账号  

KUBECONFIG                  #kubeconfig认证文件路径  
DOCKER_HOST                 #docker服务启动参数  
DOCKER_DRIVER               #docker服务启动参数  
DOCKER_TLS_CERTDIR          #docker服务启动参数  
HARBOR_NAMESPACE            #harobor仓库命名空间  
BRANCH_NAME                 #工程分支名称  
APP_NAME                    #工程镜像名称（harbor仓库中使用）  
BUILD_NUMBER                #流水线序号  

## 4.3 job配置
### 4.3.1标准规范

job命名规范：全英文小写，单词间使用'-'连接  
主要参数：  
stage：job所属流水线阶段  
image：excutor基础镜像  
services：使用did方式实际执行脚本的镜像  
script： 执行脚本，实现打包部署等操作  
rules： 设置job规则  

示例文件：[.gitlab-ci.yml](http://10.20.91.100:9980/root/vue-ci-sample/-/blob/master/.gitlab-ci.yml)

# 5 gitlab-ci 执行及调试
待补充
