variables:
  #docker服务启动参数
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_DRIVER: overlay2 
  DOCKER_TLS_CERTDIR: ""
  #下面流水线需要用到的变量
  REGISTRY: '10.20.91.100'
  DOCKERHUB_NAMESPACE: 'library'
  BRANCH_NAME: master
  GITHUB_ACCOUNT: 'kubesphere'
  APP_NAME: 'vue-sample-1'
  BUILD_NUMBER: $CI_PIPELINE_ID

cache:
  paths:
    - node_modules/
    - dist/

docker-build-and-deploy-k8s:
  stage: deploy
  image: docker:20.10.12
  services:
    - name: docker:20.10.12-dind
      command: ["--insecure-registry=10.20.91.100"]


  script:
    - echo "This job building  something, $REGISTRY_USER, $REGISTRY_PASSWORD , $REGISTRY"
    - echo "$REGISTRY_PASSWORD" | docker login $REGISTRY -u "$REGISTRY_USER" --password-stdin
    - docker build -f Dockerfile -t $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:SNAPSHOT-$BRANCH_NAME-$BUILD_NUMBER .
    - docker push  $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:SNAPSHOT-$BRANCH_NAME-$BUILD_NUMBER
    - apk add --no-cache gettext #在apline操作系统中，安装 envsubst 命令

    - envsubst < deploy/prod/devops-svc.yaml | kubectl apply -f -  #再创建 service deployment pod
    - envsubst < deploy/prod/devops.yaml | kubectl apply -f -
    - sleep 6000

  rules:
    - allow_failure: true
